name: Deploy app to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - "app/**" # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  deploy:
    name: Deploy app to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app # ëª¨ë“  run ëª…ë ¹ì€ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt   # app/requirements.txt ê¸°ì¤€

      - name: Run tests (optional)
        run: |
          # í…ŒìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ì‹¤í–‰
          # pytest tests/ || true
          echo "Tests skipped for now"

      - name: Configure SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH í‚¤ ê²€ì¦
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âŒ EC2_SSH_KEY secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # SSH í‚¤ í˜•ì‹ ê²€ì¦
          if ! grep -q "BEGIN" ~/.ssh/deploy_key; then
            echo "âŒ SSH í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi

          # í˜¸ìŠ¤íŠ¸ ê²€ì¦
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ EC2_HOST secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # known_hostsì— í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

          echo "âœ… SSH ì„¤ì • ì™„ë£Œ"

      - name: Deploy app to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -e

          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ EC2_HOST ë˜ëŠ” EC2_USER secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ“¤ app í´ë”ë¥¼ EC2ì— ë°°í¬ ì¤‘..."

          # app í´ë” ì „ì²´ë¥¼ EC2ì— ë™ê¸°í™” (rsync ì‚¬ìš©)
          # í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ê°€ app/ ì´ë¯€ë¡œ . ì„ ì‚¬ìš©
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='venv' \
            --exclude='*.log' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts" \
            . $EC2_USER@$EC2_HOST:/home/ubuntu/rag-app/ || {
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            exit 1
          }

          echo "ğŸš€ EC2ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ë° ì‹œì‘..."
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            APP_DIR="/home/ubuntu/rag-app"
            cd "$APP_DIR"

            # Python ë²„ì „ í™•ì¸
            echo "ğŸ” Python ë²„ì „ í™•ì¸..."
            if command -v python3.11 &> /dev/null; then
              PYTHON_CMD=python3.11
              echo "âœ… Python 3.11 ë°œê²¬"
            elif command -v python3 &> /dev/null; then
              PYTHON_CMD=python3
              echo "âœ… Python3 ë°œê²¬: $(python3 --version)"
            else
              echo "âŒ Pythonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # ê°€ìƒ í™˜ê²½ ì„¤ì •
            if [ ! -d "venv" ]; then
              echo "ğŸ ê°€ìƒ í™˜ê²½ ìƒì„± ì¤‘..."
              # venv ëª¨ë“ˆ í™•ì¸ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
              if ! $PYTHON_CMD -m venv --help &> /dev/null; then
                echo "âš ï¸ venv ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
                sudo apt-get update -qq
                sudo apt-get install -y python3-venv || {
                  echo "âŒ python3-venv ì„¤ì¹˜ ì‹¤íŒ¨"
                  exit 1
                }
              fi

              # ê°€ìƒ í™˜ê²½ ìƒì„±
              $PYTHON_CMD -m venv venv || {
                echo "âŒ ê°€ìƒ í™˜ê²½ ìƒì„± ì‹¤íŒ¨"
                echo "Python ë²„ì „: $($PYTHON_CMD --version)"
                exit 1
              }

              # ê°€ìƒ í™˜ê²½ ìƒì„± í™•ì¸
              if [ ! -f "venv/bin/activate" ]; then
                echo "âŒ ê°€ìƒ í™˜ê²½ ìƒì„± ì‹¤íŒ¨ (activate íŒŒì¼ ì—†ìŒ)"
                echo "venv ë””ë ‰í„°ë¦¬ ë‚´ìš©:"
                ls -la venv/ || true
                exit 1
              fi
              echo "âœ… ê°€ìƒ í™˜ê²½ ìƒì„± ì™„ë£Œ"
            else
              echo "âœ… ê¸°ì¡´ ê°€ìƒ í™˜ê²½ ì‚¬ìš©"
              # ê¸°ì¡´ venvê°€ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸
              if [ ! -f "venv/bin/activate" ]; then
                echo "âš ï¸ ê¸°ì¡´ venvê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ìƒì„±í•©ë‹ˆë‹¤..."
                rm -rf venv
                $PYTHON_CMD -m venv venv || {
                  echo "âŒ ê°€ìƒ í™˜ê²½ ì¬ìƒì„± ì‹¤íŒ¨"
                  exit 1
                }
              fi
            fi

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜..."
            # ê°€ìƒ í™˜ê²½ í™œì„±í™”
            source venv/bin/activate || {
              echo "âŒ ê°€ìƒ í™˜ê²½ í™œì„±í™” ì‹¤íŒ¨"
              echo "venv ë””ë ‰í„°ë¦¬ ë‚´ìš©:"
              ls -la venv/bin/ || true
              exit 1
            }

            # pip ì—…ê·¸ë ˆì´ë“œ
            pip install --upgrade pip

            # requirements.txt í™•ì¸
            if [ ! -f "requirements.txt" ]; then
              echo "âŒ requirements.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # ì˜ì¡´ì„± ì„¤ì¹˜
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              if [ -f "env.example" ]; then
                cp env.example .env
                echo "ğŸ“ env.exampleì„ .envë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”."
              fi
            fi

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ë˜ëŠ” ì‹œì‘
            if systemctl list-unit-files | grep -q "rag-app.service"; then
              if systemctl is-active --quiet rag-app; then
                echo "ğŸ”„ systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
                sudo systemctl restart rag-app
              else
                echo "â–¶ï¸ systemd ì„œë¹„ìŠ¤ ì‹œì‘..."
                sudo systemctl start rag-app
              fi
              sudo systemctl status rag-app --no-pager || true
            else
              echo "âš ï¸ systemd ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤..."
              # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
              pkill -f "uvicorn app.main:app" || true
              sleep 2

              # ê°€ìƒ í™˜ê²½ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì‹¤í–‰
              # venv/bin/uvicorn ê²½ë¡œ í™•ì¸
              if [ ! -f "venv/bin/uvicorn" ]; then
                echo "âŒ venv/bin/uvicornì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                echo "venv/bin ë‚´ìš©:"
                ls -la venv/bin/ || true
                exit 1
              fi

              # ìƒˆë¡œ ì‹œì‘ (ê°€ìƒ í™˜ê²½ í™œì„±í™” ìƒíƒœ ìœ ì§€)
              nohup venv/bin/uvicorn app.main:app \
                  --host 0.0.0.0 \
                  --port 8000 \
                  --workers 2 \
                  > app.log 2>&1 &

              echo $! > app.pid
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. PID: $(cat app.pid)"
            fi

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬..."
            sleep 5

            for i in {1..10}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                exit 0
              fi
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 2
            done

            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
            exit 1
          ENDSSH

      - name: Verify deployment
        run: |
          set -e
          sleep 10

          EC2_HOST="${{ secrets.EC2_HOST }}"

          # HTTPë¡œ í—¬ìŠ¤ì²´í¬ ì‹œë„ (HTTPSëŠ” ë‚˜ì¤‘ì— ì„¤ì • ê°€ëŠ¥)
          if curl -f --max-time 10 http://$EC2_HOST:8000/health 2>/dev/null; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (í¬íŠ¸ 8000)"
          elif curl -f --max-time 10 http://$EC2_HOST/health 2>/dev/null; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (í¬íŠ¸ 80)"
          else
            echo "âš ï¸ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ë°©í™”ë²½ ì„¤ì • í™•ì¸ í•„ìš”)"
            echo "   EC2 ë³´ì•ˆ ê·¸ë£¹ì—ì„œ í¬íŠ¸ 8000 ë˜ëŠ” 80ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µìœ¼ë¡œ ê°„ì£¼ (ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì‘ë™í•  ìˆ˜ ìˆìŒ)
          fi
